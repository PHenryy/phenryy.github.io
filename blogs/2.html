<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>开发一个 Graphql todo web app | PHenryy</title>
    <meta name="description" content="just another blog">
    
    
    <link rel="preload" href="/assets/css/0.styles.83d1111a.css" as="style"><link rel="preload" href="/assets/js/app.cea8de6d.js" as="script"><link rel="preload" href="/assets/js/4.304c34ee.js" as="script"><link rel="preload" href="/assets/js/1.87b9b94e.js" as="script"><link rel="preload" href="/assets/js/10.0bac312a.js" as="script"><link rel="prefetch" href="/assets/js/11.d9e0943d.js"><link rel="prefetch" href="/assets/js/12.f55bf1ba.js"><link rel="prefetch" href="/assets/js/13.1dadf224.js"><link rel="prefetch" href="/assets/js/14.131f27b4.js"><link rel="prefetch" href="/assets/js/15.48d07c58.js"><link rel="prefetch" href="/assets/js/16.4fa119ee.js"><link rel="prefetch" href="/assets/js/17.283282fc.js"><link rel="prefetch" href="/assets/js/18.da0ea4fe.js"><link rel="prefetch" href="/assets/js/3.9eb47506.js"><link rel="prefetch" href="/assets/js/5.18c4b9b1.js"><link rel="prefetch" href="/assets/js/6.907ab8ac.js"><link rel="prefetch" href="/assets/js/7.dd400d47.js"><link rel="prefetch" href="/assets/js/8.7e8b3242.js"><link rel="prefetch" href="/assets/js/9.6a058516.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83d1111a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="bg-black"><div class="w-full h-16"><div class="flex justify-between items-center w-240 m-auto h-full"><a href="/blogs" class="router-link-active"><img src="/assets/img/PHenryy.9807e49e.svg" class="w-30"></a> <ul class="flex items-center"><li><div class="search-box rounded-none"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></li> <li><a href="/resources" class="text-white">资源</a></li></ul></div></div> <div class="w-240 m-auto flex"><div class="post max-w-180 text-white"><div class="content__article"><h1 id="graphql-todo-web-app"><a href="#graphql-todo-web-app" aria-hidden="true" class="header-anchor">#</a> Graphql todo web app</h1> <p>Graphql 是 Facebook 从 2012 年开始开发，并于 2015 年开源的一个用于 API 的查询语言，是一个使用基于类型系统来执行查询的服务端运行时（类型系统由你的数据定义）。</p> <hr> <p>Graphql 变得越来越流行，现在，我们使用 vue-apollo、apollo-client 来实现一个
todo 应用。</p> <hr> <h2 id="_1-创建一个-vue-项目"><a href="#_1-创建一个-vue-项目" aria-hidden="true" class="header-anchor">#</a> 1. 创建一个 vue 项目</h2> <div class="language- extra-class"><pre class="language-text"><code>$ vue create todo
</code></pre></div><h2 id="_2-安装及配置-tailwindcss"><a href="#_2-安装及配置-tailwindcss" aria-hidden="true" class="header-anchor">#</a> 2. 安装及配置 tailwindcss</h2> <p>过程参考另一篇 <a href="/blogs/3.html">文章</a></p> <h2 id="_3-安装-vue-apollo"><a href="#_3-安装-vue-apollo" aria-hidden="true" class="header-anchor">#</a> 3. 安装 vue-apollo</h2> <div class="language- extra-class"><pre class="language-text"><code>$ npm install --save vue-apollo graphql apollo-boost
</code></pre></div><p>创建 <code>provider</code> 并在 <code>main.js</code> 中引入</p> <div class="language- extra-class"><pre class="language-text"><code>$ cd src &amp;&amp; touch vue-apollo.js
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue-apollo.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueApollo <span class="token keyword">from</span> <span class="token string">'vue-apollo'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ApolloClient <span class="token keyword">from</span> <span class="token string">'apollo-boost'</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueApollo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> apolloClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> apolloProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueApollo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  defaultClient<span class="token punctuation">:</span> apolloClient
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> apolloProvider<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> apolloProvider <span class="token keyword">from</span> <span class="token string">'./vue-apollo'</span><span class="token punctuation">;</span>
<span class="token comment">// ...其他模块</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
  apolloProvider
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-初始化-apollo-cache"><a href="#_4-初始化-apollo-cache" aria-hidden="true" class="header-anchor">#</a> 4. 初始化 Apollo cache</h2> <p>使用 Apollo Client 2.0 推荐的缓存实现： <code>apollo-cache-inmemory</code>，在 vue-apollo.js 文件中添加以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> InMemoryCache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'apollo-cache-inmemory'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> apolloProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueApollo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cache
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样，我们的缓存已经设置好了，现在我们有了一个空的 <code>store</code>，我们要往里面添加一些数据，正如我们在服务端使用 <code>GraphQL</code> 那样，我们首先要书写数据的 <code>schema</code> 。</p> <h2 id="_5-编写本地-schema"><a href="#_5-编写本地-schema" aria-hidden="true" class="header-anchor">#</a> 5. 编写本地 <code>schema</code></h2> <p>一个 to-do 应用，每一个 item 应该有一些属性：1. 一个唯一的 ID 属性，以供之后的“完成”、“删除”等操作；2. 内容字段；3. 一个标志是否完成的字段。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token constant">ID</span><span class="token punctuation">,</span>
  text<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  done<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在让我们创建一些必要的文件，用法我们在之后会介绍：</p> <div class="language- extra-class"><pre class="language-text"><code>$ cd src
$ touch resolvers.js
$ mkdir graphql &amp;&amp; cd graphql
$ touch schemas.gql queries.gql mutations.gql
</code></pre></div><p>在 schemas.gql 文件中定义 Item 的 <code>schema</code></p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">text</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
  <span class="token attr-name">done</span><span class="token punctuation">:</span> Boolean<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 resolvers.js 中导出一个空对象（暂时）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>然后把我们刚刚定义好的 <code>schema</code> 和 <code>resolvers</code> 加到 ApolloClient 参数中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> typeDefs <span class="token keyword">from</span> <span class="token string">'@/graphql/schemas.gql'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> resolvers <span class="token keyword">from</span> <span class="token string">'@/resolvers'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> apolloClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cache<span class="token punctuation">,</span>
  typeDefs<span class="token punctuation">,</span>
  resolvers
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在 <code>vue.config.js</code> 中配置 <code>GraphQL Loader</code> 以识别 gql 文件</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">chainWebpack</span><span class="token punctuation">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// GraphQL Loader</span>
    config<span class="token punctuation">.</span>module
      <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex">/\.(graphql|gql)$/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'graphql-tag/loader'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token string">'graphql-tag/loader'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-写入初始数据"><a href="#_6-写入初始数据" aria-hidden="true" class="header-anchor">#</a> 6. 写入初始数据</h2> <p>我们向 <code>store</code> 中写入一个初始的 <code>Item</code> 来测试目前为止的修改有效，向 <code>cache</code> 中写入数据，ApolloClient 提供了两个方法：<code>writeData</code> 和 <code>writeQuery</code>，我们使用</p> <p><code>writeData</code> 向缓存中直接写入数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...  ApolloClient 的代码后面</span>
cache<span class="token punctuation">.</span><span class="token function">writeData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    todoItems<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        __typename<span class="token punctuation">:</span> <span class="token string">'Item'</span><span class="token punctuation">,</span> <span class="token comment">// 在 schemas.gql 中定义的名字</span>
        id<span class="token punctuation">:</span> <span class="token string">'PPBqWA9'</span><span class="token punctuation">,</span> <span class="token comment">// 我这里是使用 shortid 随机生产的</span>
        text<span class="token punctuation">:</span> <span class="token string">'想办法干他一炮'</span><span class="token punctuation">,</span>
        done<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行命令：</p> <div class="language- extra-class"><pre class="language-text"><code>npm run serve
</code></pre></div><p>打开 <code>localhost:8080</code> 并打开 <a href="https://chrome.google.com/webstore/detail/apollo-client-developer-t/jdkknkkbebbapilgoeccciglkfbmbnfm?hl=en-US" target="_blank" rel="noopener noreferrer">Apollo Client Developer Tools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，在
<code>Cache</code> 一栏中如果看到下图的数据，则说明成功写入了 <code>Item</code> <img src="/assets/img/write_data.5cfc37bf.png" alt="write_data"></p> <p>*** 注意，<code>console</code> 中有一个错误： POST http://localhost:8081/graphql 404 (Not Found)，是因为我们没有提供 <code>http endpoint</code>，暂时忽略它 ***</p> <h2 id="_7-编写-template"><a href="#_7-编写-template" aria-hidden="true" class="header-anchor">#</a> 7. 编写 <code>template</code></h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex justify-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pt-20<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>w-150 bg-white rounded-sm h-37.5 flex items-center justify-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>relative w-125<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>w-full border-b-2 border-solid border-gray py-3.5 text-large outline-none text-write-primary px-3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>写下你想做的事<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>@/assets/images/add.svg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>absolute right-3 bottom-3 cursor-pointer<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>w-150 bg-white rounded-sm pl-13.5 py-13.5 mt-3.5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex justify-between items-center w-125 mb-3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex items-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>w-3 h-3 rounded-1/2 bg-red mr-5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text-write-primary text-lg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>写一篇Blog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>@/assets/images/delete.svg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex-shrink-0 w-6 cursor-pointer<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_8-获取-to-do-列表数据"><a href="#_8-获取-to-do-列表数据" aria-hidden="true" class="header-anchor">#</a> 8. 获取 <code>to-do</code> 列表数据</h2> <p>获取数据的第一步需要我们编写 <code>query</code>，在 <code>queries.gql</code> 文件中写入下面这个 <code>query</code>：</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">query</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">{</span>
  todoItems <span class="token directive function">@client</span> <span class="token punctuation">{</span>
    id
    text
    done
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>*** <code>@client</code> 表示我们从 <code>cache</code> 中请求数据，而不是服务端 ***</p> <p>在组件中引入 <code>query</code>，并使用 <code>vue-apollo</code> 提供的方式请求数据并注入到组件中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/graphql/queries.gql'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>
  components<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  apollo<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    todoItems<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>修改之前的 <code>template</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item in todoItems<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item.id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex justify-between items-center w-125 mb-3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex items-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>w-3 h-3 rounded-1/2 mr-5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[ item.done ? 'bg-green' : 'bg-red' ]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text-write-primary text-lg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{ 'line-through': item.done }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ item.text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>@/assets/images/delete.svg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>flex-shrink-0 w-6 cursor-pointer<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_9-修改本地缓存"><a href="#_9-修改本地缓存" aria-hidden="true" class="header-anchor">#</a> 9. 修改本地缓存</h2> <p>修改 <code>cache</code> 需要使用 <code>mutations</code>，和 <code>Query Type</code> 类似， <code>GraphQL</code> 同样有 <code>Mutation Type</code>，首先需要定义 <code>schema</code>，在 <code>schemas.gql</code> 文件中添加：</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Mutation</span> <span class="token punctuation">{</span>
  <span class="token attr-name">addTodo</span><span class="token punctuation">(</span><span class="token attr-name">text</span><span class="token punctuation">:</span> String<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Boolean
  <span class="token attr-name">deleteTodo</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Boolean
  <span class="token attr-name">checkTodo</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Boolean
<span class="token punctuation">}</span>
</code></pre></div><p>有了 <code>schema</code> 之后，在 <code>mutation.gql</code> 文件中添加变更请求：</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">mutation</span> <span class="token constant">ADD_TODO</span><span class="token punctuation">(</span><span class="token variable">$text</span><span class="token punctuation">:</span> String<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  addTodo<span class="token punctuation">(</span><span class="token attr-name">text</span><span class="token punctuation">:</span> <span class="token variable">$text</span><span class="token punctuation">)</span> <span class="token directive function">@client</span>
<span class="token punctuation">}</span>

<span class="token keyword">mutation</span> <span class="token constant">DELETE_TODO</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deleteTodo<span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token directive function">@client</span>
<span class="token punctuation">}</span>

<span class="token keyword">mutation</span> <span class="token constant">TOGGLE_DONE</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  toggleDone<span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token directive function">@client</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来要写每个 <code>mutation</code> 对应的 <code>resolver</code>，在 <code>resolvers</code> 中添加：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/graphql/queries.gql'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> shortid <span class="token keyword">from</span> <span class="token string">'shortid'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Mutation<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> text <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cache <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> todoItems <span class="token punctuation">}</span> <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">readQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache<span class="token punctuation">.</span><span class="token function">writeQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          todoItems<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token operator">...</span>todoItems<span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              __typename<span class="token punctuation">:</span> <span class="token string">'Item'</span><span class="token punctuation">,</span>
              id<span class="token punctuation">:</span> shortid<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              text<span class="token punctuation">,</span>
              done<span class="token punctuation">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deleteTodo</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cache <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> todoItems <span class="token punctuation">}</span> <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">readQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache<span class="token punctuation">.</span><span class="token function">writeQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span> todoItems<span class="token punctuation">:</span> todoItems<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token operator">!==</span> id<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">toggleDone</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cache <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> todoItems <span class="token punctuation">}</span> <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">readQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache<span class="token punctuation">.</span><span class="token function">writeQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          todoItems<span class="token punctuation">:</span> todoItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>item<span class="token punctuation">,</span> done<span class="token punctuation">:</span> <span class="token operator">!</span>item<span class="token punctuation">.</span>done <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">return</span> item<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>resolver function</code> 的 <a href="https://www.apollographql.com/docs/react/essentials/local-state/#local-resolvers" target="_blank" rel="noopener noreferrer">四个参数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 在链接中有详细描述，
在此处我们只是用到了 <code>cache</code> 的 <code>readQuery</code> 和 <code>writeQuery</code>，其实还有其他的函数可以操作本地状态(如 <code>readFragment</code> 和 <code>writeFragment</code>)，结合起来使用
能极大的提高数据操作的效率</p> <h2 id="_10-发起变更-mutate"><a href="#_10-发起变更-mutate" aria-hidden="true" class="header-anchor">#</a> 10. 发起变更 <code>mutate</code></h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TODO_ITEMS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/graphql/queries.gql'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ADD_TODO</span><span class="token punctuation">,</span> <span class="token constant">DELETE_TODO</span><span class="token punctuation">,</span> <span class="token constant">TOGGLE_DONE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/graphql/mutations.gql'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'app'</span><span class="token punctuation">,</span>
  components<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  apollo<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    todoItems<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      query<span class="token punctuation">:</span> <span class="token constant">TODO_ITEMS</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      text<span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">handleAddTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">ADD_TODO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> text <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$apollo<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mutation<span class="token punctuation">:</span> <span class="token constant">ADD_TODO</span><span class="token punctuation">,</span>
        variables<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          text
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleToggleDone</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$apollo<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mutation<span class="token punctuation">:</span> <span class="token constant">TOGGLE_DONE</span><span class="token punctuation">,</span>
        variables<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          id
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleDeleteTodo</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$apollo<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mutation<span class="token punctuation">:</span> <span class="token constant">DELETE_TODO</span><span class="token punctuation">,</span>
        variables<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          id
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_11-运行查看结果"><a href="#_11-运行查看结果" aria-hidden="true" class="header-anchor">#</a> 11. 运行查看结果</h2> <p><img src="/assets/img/todo_result.f26126fb.png" alt="结果"></p> <p><a href="https://github.com/PHenryy/todo" target="_blank" rel="noopener noreferrer">源码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></div> <aside class="sticky top-6 h-0 ml-12 text-white w-64 py-8 align-top text-write-secondary text-normal"><div class="content__toc"><p></p><div class="table-of-contents"><ul><li><a href="#_1-创建一个-vue-项目">1. 创建一个 vue 项目</a></li><li><a href="#_2-安装及配置-tailwindcss">2. 安装及配置 tailwindcss</a></li><li><a href="#_3-安装-vue-apollo">3. 安装 vue-apollo</a></li><li><a href="#_4-初始化-apollo-cache">4. 初始化 Apollo cache</a></li><li><a href="#_5-编写本地-schema">5. 编写本地 schema</a></li><li><a href="#_6-写入初始数据">6. 写入初始数据</a></li><li><a href="#_7-编写-template">7. 编写 template</a></li><li><a href="#_8-获取-to-do-列表数据">8. 获取 to-do 列表数据</a></li><li><a href="#_9-修改本地缓存">9. 修改本地缓存</a></li><li><a href="#_10-发起变更-mutate">10. 发起变更 mutate</a></li><li><a href="#_11-运行查看结果">11. 运行查看结果</a></li></ul></div><p></p></div></aside></div> <div class="w-full py-20 flex justify-center"><div class="w-48 mx-5"><h5 class="text-white mb-5">联系</h5> <ul class="flex"><li class="mr-2"><a href="mailto:qwerty.code24@gmail.com"><img src="/assets/img/gmail.08141dc3.svg" alt="Google Mail"></a></li> <li class="mr-2"><a href="mailto:775087535@qq.com"><img src="/assets/img/qq.7f79aa1b.svg" alt="QQ Mail"></a></li> <li class="mr-2"><a href="https://github.com/PHenryy"><img src="/assets/img/github.44ad2391.svg" alt="Github"></a></li></ul></div> <div class="w-48 mx-5"><h5 class="text-white mb-5">友链</h5> <ul class="flex"><li class="mr-2"><a href="https://www.jackeriss.com/" class="text-white">Jackeriss</a></li></ul></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cea8de6d.js" defer></script><script src="/assets/js/4.304c34ee.js" defer></script><script src="/assets/js/1.87b9b94e.js" defer></script><script src="/assets/js/10.0bac312a.js" defer></script>
  </body>
</html>
